# 初始化集群部署环境

前面几章我们分别完成了yum本地源服务，dns服务以及ntp服务的创建和配置，接下来我们要为集群中的所有主机配置这些基础服务，进一步还要进行安装部署前的环境初始化和检查。

* 禁用防火墙

```
systemctl stop firewalld.service
systemctl disable firewalld.service

setenforce 0  #临时关闭Selinux
sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config  #开机不启动Selinux
```

* 检查UMASK值

UMASK值设置了用户在系统中创建新文件或文件夹时被授予的默权限或基本权限，大数据平台支持的umask值为022/0022和027/0027。集群中的所有主机均要利用umask命令检查或修改umask值。

```
[root@gw ~]# umask  #查询umask值
0022

[root@gw ~]# umask 022   #设置umask值为022
```

* SSH免密登录

在大数据平台部署过程中，为了让Server自动地在所有集群主机上安装Agent，必须在Server主机和其他所有主机之间设置无密码的ssh连接。这样Server主机就能够使用ssh公钥通过身份验证来访问和安装Agent。

在Server主机上生成ssh公钥和私钥。

```
ssh-keygen

[root@server ~]# ls -l ~/.ssh
total 12
-rw-------. 1 root root  409 May  3 02:56 authorized_keys
-rw-------. 1 root root 1679 May 11 08:54 id_rsa       #私钥
-rw-r--r--. 1 root root  408 May 11 08:54 id_rsa.pub   #公钥
```

将生成的ssh公钥复制到其他主机的/root/.ssh目录。

```
scp /root/.ssh/id_rsa.pub root@192.168.70.101:/root/.ssh/
```

在目标主机上将ssh公钥添加到authorized\_keys文件中。

```
cat id_rsa.pub >> authorized_keys
```

然后验证从Server中利用ssh登录目标主机，确保无需输入密码而能够正常登录。

```
ssh root@192.168.70.101
Are you sure you want to continue connecting (yes/no)? #第一登录会询问是否继续
```

* DNS设置和检查

Centos7新增了NetworkManager来提供默认的网络服务，它是一个动态的网络控制和配置守护进程，在/etc/resolv.conf中修改nameserver后，它会定期的恢复成初始值。所以，我们需要禁止NetworkManager定期恢复dns。

```
[root@server ~]# cat /etc/NetworkManager/NetworkManager.conf
[main]
plugins=ifcfg-rh
dns=none               #禁止更新dns

[logging]
#level=DEBUG
#domains=ALL

[root@server ~]# systemctl restart NetworkManager.service #重启NetworkManager服务
```

```
#配置dns
cat << eof > /etc/resolv.conf
# Generated by NetworkManager
search bigdata.wh.com
nameserver 192.168.36.149
eof
```

* 在DNS服务器中为集群其他主机添加A记录和PTR记录

```
[root@dns named]# cat bigdata.wh.com.zone 
$TTL 600
$ORIGIN bigdata.wh.com.
@   IN  SOA    dns.bigdata.wh.com. admin.bigdata.wh.com. (
                20170510
                1H
                5M
                1W
                10M )
        IN      NS      dns
dns     IN      A       192.168.36.149
repo    IN      A       192.168.36.247  #区域内其他主机的A记录
db      IN      A       192.168.36.101
server  IN      A       192.168.70.100
gw      IN      A       192.168.70.101
nn      IN      A       192.168.70.102
sn      IN      A       192.168.70.103
dn001   IN      A       192.168.70.104
dn002   IN      A       192.168.70.105
admin   IN      CNAME   dns
*       IN      A       192.168.30.1

[root@dns named]# cat 36.168.192.in-addr.arpa.zone 
$TTL 600
$ORIGIN 36.168.192.in-addr.arpa.
@ IN SOA dns.bigdata.wh.com. admin.bigdata.wh.com. (
20170510
1H
5M
1W
10M )
    IN NS  dns.bigdata.wh.com.
149 IN PTR dns.bigdata.wh.com.
247 IN PTR repo.bigdata.wh.com.    #区域内其他主机的PTR记录
101 IN PTR db.bigdata.wh.com.
100 IN PTR server.bigdata.wh.com.
101 IN PTR gw.bigdata.wh.com.
102 IN PTR nn.bigdata.wh.com.
103 IN PTR sn.bigdata.wh.com.
104 IN PTR dn001.bigdata.wh.com.
105 IN PTR dn002.bigdata.wh.com.
*   IN PTR 192.168.30.1
```

* Yum设置本地仓库

备份系统默认源。

```
mv /etc/yum.repos.d /etc/yum.repos.d.bak
mkdir /etc/yum.repos.d
```

下载之前创建的本地源repo文件，更新yum缓存

```
wget -O /etc/yum.repos.d/bigdata.repo http://repo.bigdata.wh.com/resource/bigdata.repo
yum clean all
yum makecache
```

* NTP时间同步

安装ntp，更新ntp client配置文件。

```
yum install -y ntp

[root@centos7 ~]# cat /etc/ntp.conf
restrict 127.0.0.1 
restrict ::1

# Hosts on local network are less restricted.
#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap
# Use public servers from the pool.ntp.org project.
# Please consider joining the pool (http://www.pool.ntp.org/join.html).
server repo.bigdata.wh.com           #设置ntp server地址，修改为内网ntp服务器
#server 0.centos.pool.ntp.org iburst
#server 1.centos.pool.ntp.org iburst
#server 2.centos.pool.ntp.org iburst
#server 3.centos.pool.ntp.org iburst
```

与之前创建的NTP服务器保持时钟同步。

```
[root@server yum.repos.d]# systemctl restart ntpd.service 
[root@server yum.repos.d]# ntpdate  -u repo.bigdata.wh.com
12 May 05:50:47 ntpdate[4136]: step time server 192.168.36.247 offset -3.068888 sec
[root@server yum.repos.d]# ntpq -p
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 repo.bigdata.wh 115.28.122.198   3 u   34   64    3    5.780  -3068.4  29.757
```

* 优化swap分区设置

```
[root@centos7 ~]# sysctl -w vm.swappiness=0      #优先使用内存，减少与磁盘交互
vm.swappiness = 0
[root@centos7 ~]# echo "vm.swappiness = 0" >> /etc/sysctl.conf
```

* 删除版本冲突的包

Centos7镜像中默认安装了高版本的snappy，hdp-util中使用的低版本的snappy，这会导致安装datanode client的时候出现版本冲突，我们先把高版本的snappy卸载掉，后续安装过程中再从本地源中下载并安装低版本。

```
yum erase -y snappy.x86_64
```



